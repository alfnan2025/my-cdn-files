var _0x127485=_0x46d4;(function(_0x5d565a,_0x24a629){var _0x30e975=_0x46d4,_0x57606d=_0x5d565a();while(!![]){try{var _0x1dd0b4=parseInt(_0x30e975(0x1cf))/0x1+-parseInt(_0x30e975(0x1e6))/0x2*(parseInt(_0x30e975(0x1e1))/0x3)+parseInt(_0x30e975(0x1aa))/0x4+parseInt(_0x30e975(0x1ab))/0x5*(parseInt(_0x30e975(0x1c2))/0x6)+-parseInt(_0x30e975(0x1d2))/0x7*(-parseInt(_0x30e975(0x1d0))/0x8)+-parseInt(_0x30e975(0x1dc))/0x9*(parseInt(_0x30e975(0x1db))/0xa)+parseInt(_0x30e975(0x1d6))/0xb;if(_0x1dd0b4===_0x24a629)break;else _0x57606d['push'](_0x57606d['shift']());}catch(_0x49324b){_0x57606d['push'](_0x57606d['shift']());}}}(_0x3cf8,0x6ef6c));function _0x3cf8(){var _0x54cbf9=['shift','331904cOVwFD','26480QUMPsE','addEventListener','42XMXjpX','click','8666400876123099283','text','1010119VMwulS','feed','head','body','b/layout-preview','10OTQYcK','3928779IzubCW','8849010cIUOsa','6TwliTe','11893992lNqExP','3109566IoiMkO','269772FMHmry','158308QewGdJ','ajax','json','post-preview','20LfOvoV','push','location','active','mobile-menu','245464YkAnYZ','www.blogger','3557884JqPFkl','15iyYwtM','error_page','ready','GET','href','script','2TstlkJ','5BCiLtk','3589048MTesgc','1447355qOIZsM','11YetNNC','12249mvWGae','find','querySelector','indexOf','toggle','entry','12NVtPrs','974142WekkfO','jsonp','8297016XIrDDZ','append','html','914430leGgjh','35MhRJAA','hasClass','16TQEYQP','hostname','template-editor','b/preview','https://www.blogger.com/feeds/','length','9718992vrBBMY','content','27biFuvj'];_0x3cf8=function(){return _0x54cbf9;};return _0x3cf8();}function _0x2def(_0xfcab5f,_0x1471cc){const _0x23738f=_0x3109();return _0x2def=function(_0x11015d,_0x48942f){_0x11015d=_0x11015d-0x10e;let _0x5566ae=_0x23738f[_0x11015d];return _0x5566ae;},_0x2def(_0xfcab5f,_0x1471cc);}const _0x4e9bef=_0x2def;(function(_0x2c311a,_0x2e5b1d){var _0x3619f7=_0x46d4;const _0x1e4b96=_0x2def,_0x2fed79=_0x2c311a();while(!![]){try{const _0x4194e8=-parseInt(_0x1e4b96(0x111))/0x1*(-parseInt(_0x1e4b96(0x11e))/0x2)+parseInt(_0x1e4b96(0x112))/0x3+parseInt(_0x1e4b96(0x113))/0x4*(parseInt(_0x1e4b96(0x10f))/0x5)+parseInt(_0x1e4b96(0x114))/0x6*(parseInt(_0x1e4b96(0x119))/0x7)+parseInt(_0x1e4b96(0x110))/0x8*(-parseInt(_0x1e4b96(0x117))/0x9)+parseInt(_0x1e4b96(0x116))/0xa+-parseInt(_0x1e4b96(0x11b))/0xb*(parseInt(_0x1e4b96(0x115))/0xc);if(_0x4194e8===_0x2e5b1d)break;else _0x2fed79[_0x3619f7(0x1e7)](_0x2fed79['shift']());}catch(_0x13d9ce){_0x2fed79['push'](_0x2fed79[_0x3619f7(0x1ce)]());}}}(_0x3109,0xbba38),document[_0x4e9bef(0x11c)](_0x4e9bef(0x10e))[_0x127485(0x1d1)](_0x4e9bef(0x11d),function(){var _0x4cb651=_0x127485;const _0x60f652=_0x4e9bef,_0x54b765=document[_0x4cb651(0x1b8)](_0x60f652(0x11a));_0x54b765[_0x60f652(0x118)][_0x4cb651(0x1ba)](_0x60f652(0x11f));}));function _0x46d4(_0x414c5f,_0x149b4a){var _0x3cf8aa=_0x3cf8();return _0x46d4=function(_0x46d469,_0xc4b0b4){_0x46d469=_0x46d469-0x1a5;var _0x3a6cf2=_0x3cf8aa[_0x46d469];return _0x3a6cf2;},_0x46d4(_0x414c5f,_0x149b4a);}function _0x3109(){var _0xd241f9=_0x127485;const _0x118299=[_0xd241f9(0x1b4),_0xd241f9(0x1b3),_0xd241f9(0x1de),_0xd241f9(0x1e0),_0xd241f9(0x1c5),_0xd241f9(0x1bd),'30156276Vzjoiv',_0xd241f9(0x1dd),_0xd241f9(0x1cd),'classList',_0xd241f9(0x1c3),'.nav-links',_0xd241f9(0x1b5),'getElementById',_0xd241f9(0x1d3),_0xd241f9(0x1a8),_0xd241f9(0x1a6),_0xd241f9(0x1a7)];return _0x3109=function(){return _0x118299;},_0x3109();}var _0x173fb8=_0x2d59;function _0x40a8(){var _0x3b6675=_0x127485,_0x47e769=['5134314aiKElJ',_0x3b6675(0x1bc),_0x3b6675(0x1bb),_0x3b6675(0x1c0),_0x3b6675(0x1e4),_0x3b6675(0x1af),'webcache.googleusercontent',_0x3b6675(0x1d5),_0x3b6675(0x1ae),_0x3b6675(0x1e5),'style',_0x3b6675(0x1a9),'2430hqYDnl',_0x3b6675(0x1da),_0x3b6675(0x1e7),_0x3b6675(0x1bf),'/posts/default?alt=json-in-script',_0x3b6675(0x1df),_0x3b6675(0x1e2),_0x3b6675(0x1be),'445287rscCSB','translate.google','toLowerCase',_0x3b6675(0x1b6),_0x3b6675(0x1c1),_0x3b6675(0x1cb),'content',_0x3b6675(0x1b2),_0x3b6675(0x1c7),_0x3b6675(0x1ca),_0x3b6675(0x1d4),_0x3b6675(0x1b9),'.redirect',_0x3b6675(0x1b1),_0x3b6675(0x1b7),'head',_0x3b6675(0x1c9),_0x3b6675(0x1c6),_0x3b6675(0x1c4),_0x3b6675(0x1ad),'location',_0x3b6675(0x1d7)];return _0x40a8=function(){return _0x47e769;},_0x40a8();}function _0x2d59(_0x3b6272,_0x610249){var _0x136a2b=_0x40a8();return _0x2d59=function(_0x30646e,_0xa2b250){_0x30646e=_0x30646e-0xb0;var _0x19535e=_0x136a2b[_0x30646e];return _0x19535e;},_0x2d59(_0x3b6272,_0x610249);}(function(_0x595777,_0x459bbc){var _0xdcfb3f=_0x127485,_0x5783c5=_0x2d59,_0x455799=_0x595777();while(!![]){try{var _0x39c869=-parseInt(_0x5783c5(0xb4))/0x1*(-parseInt(_0x5783c5(0xc3))/0x2)+-parseInt(_0x5783c5(0xb6))/0x3*(-parseInt(_0x5783c5(0xcd))/0x4)+parseInt(_0x5783c5(0xbd))/0x5*(-parseInt(_0x5783c5(0xcc))/0x6)+parseInt(_0x5783c5(0xb1))/0x7+parseInt(_0x5783c5(0xbb))/0x8+-parseInt(_0x5783c5(0xb9))/0x9*(parseInt(_0x5783c5(0xd8))/0xa)+-parseInt(_0x5783c5(0xb3))/0xb;if(_0x39c869===_0x459bbc)break;else _0x455799[_0xdcfb3f(0x1e7)](_0x455799['shift']());}catch(_0x3254ea){_0x455799[_0xdcfb3f(0x1e7)](_0x455799['shift']());}}}(_0x40a8,0xb3b2b),$(document)[_0x173fb8(0xc9)](function(){var _0xa8b3e1=_0x173fb8,_0x185ae2=_0xa8b3e1(0xc0);$(function(){'use strict';var _0x39b03f=_0x46d4;var _0x3d5c56=_0xa8b3e1;$[_0x39b03f(0x1e3)]({'dataType':_0x3d5c56(0xd0),'url':_0x3d5c56(0xc6)+_0x185ae2+_0x3d5c56(0xb2),'method':_0x3d5c56(0xd4),'dataType':_0x3d5c56(0xb5),'success':function(_0x389525){var _0x1a3835=_0x39b03f,_0x4f86d0=_0x3d5c56,_0x28c93e;for(_0x28c93e=0x0;_0x28c93e<_0x389525[_0x4f86d0(0xcb)][_0x4f86d0(0xce)][_0x1a3835(0x1ca)];_0x28c93e+=0x1){var _0x21e549=$(_0x389525[_0x4f86d0(0xcb)][_0x4f86d0(0xce)][_0x28c93e][_0x4f86d0(0xbc)]['$t']);if(0x0===_0x28c93e&&!$(_0x1a3835(0x1d9))[_0x4f86d0(0xc8)](_0x1a3835(0x1ac))){for(var _0x2892bf=_0x21e549[_0x4f86d0(0xc4)]('li'),_0x4565ec=[],_0x311fa6=0x0;_0x311fa6<_0x2892bf[_0x4f86d0(0xbf)];_0x311fa6+=0x1)_0x4565ec[_0x4f86d0(0xb0)]($(_0x2892bf[_0x311fa6])[_0x4f86d0(0xd3)]());var _0x357ad5,_0x3d4358=window[_0x4f86d0(0xca)][_0x4f86d0(0xc7)][_0x4f86d0(0xb8)](),_0x25ad5c=window[_0x1a3835(0x1a5)][_0x4f86d0(0xd1)][_0x4f86d0(0xb8)](),_0x19345e=_0x4565ec[_0x4f86d0(0xbf)]-0x1;for(_0x357ad5=0x0;_0x357ad5<_0x4565ec[_0x1a3835(0x1ca)];_0x357ad5+=0x1){if(-0x1!=_0x3d4358[_0x4f86d0(0xc1)](_0x4565ec[_0x357ad5])){var _0x2fb274=$(_0x389525[_0x4f86d0(0xcb)][_0x4f86d0(0xce)][_0x28c93e][_0x4f86d0(0xbc)]['$t'])['find'](_0x1a3835(0x1b0)),_0x46aa38=$(_0x389525[_0x4f86d0(0xcb)][_0x4f86d0(0xce)][_0x28c93e][_0x4f86d0(0xbc)]['$t'])[_0x1a3835(0x1b7)](_0x4f86d0(0xd6));$(_0x4f86d0(0xc5))[_0x1a3835(0x1c0)](_0x46aa38),$(_0x1a3835(0x1d8))[_0x1a3835(0x1c0)](_0x2fb274);break;}_0x357ad5==_0x19345e&&-0x1==_0x25ad5c['indexOf'](_0x4f86d0(0xd5))&&-0x1==_0x25ad5c[_0x1a3835(0x1b9)](_0x4f86d0(0xd7))&&-0x1==_0x25ad5c[_0x4f86d0(0xc1)](_0x4f86d0(0xd9))&&-0x1==_0x25ad5c[_0x4f86d0(0xc1)](_0x1a3835(0x1c8))&&-0x1==_0x25ad5c[_0x4f86d0(0xc1)](_0x4f86d0(0xb7))&&-0x1==_0x25ad5c[_0x4f86d0(0xc1)](_0x4f86d0(0xd2))&&-0x1==_0x25ad5c[_0x4f86d0(0xc1)](_0x4f86d0(0xbe))&&$('html')[_0x4f86d0(0xba)](_0x21e549[_0x4f86d0(0xc4)](_0x4f86d0(0xc2))[_0x1a3835(0x1c1)]());}}0x1===_0x28c93e&&(_0x46aa38=$(_0x389525[_0x1a3835(0x1d7)][_0x4f86d0(0xce)][_0x28c93e][_0x1a3835(0x1cc)]['$t'])[_0x4f86d0(0xc4)](_0x4f86d0(0xd6)),$(_0x4f86d0(0xc5))[_0x4f86d0(0xcf)](_0x46aa38));}}});});}));
document.addEventListener("DOMContentLoaded", function () {
  let selectedStars = 0;
  const scriptURL = "https://script.google.com/macros/s/AKfycbxAznk5rudobevlDA2NsBUHW9LxYikCm8LACmNKGTCYAmm4efCUiooNwh_xmHqKOQ3qYA/exec";
  const postId = window.location.pathname.split("/").pop(); // ✅ استخراج معرف التدوينة
  const reviewKey = "reviewed_" + postId; // ✅ تخزين التقييم لكل تدوينة على حدة

  // ✅ تحميل التقييمات فورًا عند تحميل الصفحة
  loadReviews();

  // ✅ التحقق مما إذا كان المستخدم قد قام بالتقييم سابقًا
  if (localStorage.getItem(reviewKey)) {
    document.getElementById("review-form").innerHTML = "<p style='color: red;'>لقد قمت بإرسال تقييم لهذه التدوينة.</p>";
    return;
  }

  // ✅ تحديد عدد النجوم عند التقييم
  document.querySelectorAll(".star").forEach(star => {
    star.addEventListener("click", function () {
      selectedStars = parseInt(this.dataset.value);
      document.querySelectorAll(".star").forEach(s => 
        s.style.color = s.dataset.value <= selectedStars ? "gold" : "gray"
      );
    });
  });

  // ✅ التحقق من إدخال اللغة العربية فقط
  function isArabic(text) {
    return /^[\u0600-\u06FF\s]+$/.test(text);
  }

  document.getElementById("username").addEventListener("input", function () {
    if (!isArabic(this.value)) {
      this.value = this.value.replace(/[^\u0600-\u06FF\s]/g, '');
    }
  });

  document.getElementById("comment").addEventListener("input", function () {
    if (!isArabic(this.value)) {
      this.value = this.value.replace(/[^\u0600-\u06FF\s]/g, '');
    }
  });

  // ✅ إرسال التقييم
  document.getElementById("submit-review").addEventListener("click", function (event) {
    event.preventDefault(); // منع إعادة تحميل الصفحة

    let username = document.getElementById("username").value.trim() || "مجهول";
    let comment = document.getElementById("comment").value.trim();

    if (selectedStars === 0 || comment === "") {
      alert("يرجى اختيار عدد النجوم وكتابة تعليق");
      return;
    }

    if (!isArabic(username) || !isArabic(comment)) {
      alert("يرجى إدخال النص باللغة العربية فقط.");
      return;
    }

    // ✅ تجهيز البيانات بصيغة x-www-form-urlencoded
    let formData = new URLSearchParams();
    formData.append("postId", postId);
    formData.append("username", username);
    formData.append("stars", selectedStars);
    formData.append("comment", comment);

    // ✅ إرسال البيانات إلى جوجل جداول
    sendReview(formData);
  });

  // ✅ إرسال التقييم إلى Google Sheets
  function sendReview(formData) {
    fetch(scriptURL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: formData.toString()
    })
    .then(response => response.json())
    .then(data => {
      alert(data.message);
      if (data.status === "success") {
        localStorage.setItem(reviewKey, "true"); // ✅ حفظ حالة التقييم لكل تدوينة
        document.getElementById("review-form").innerHTML = "<p style='color: red;'>شكرًا! لقد قمت بإرسال تقييم لهذه التدوينة.</p>";
        loadReviews(); // تحديث التقييمات بعد الإرسال
      }
    })
    .catch(error => {
      console.error("Error:", error);
      alert("حدث خطأ أثناء إرسال التقييم.");
    });
  }

  // ✅ تحميل التقييمات من Google Sheets حسب معرف التدوينة
  async function loadReviews() {
    try {
      // ✅ التحقق إذا كانت التقييمات موجودة في الذاكرة المحلية
      if (localStorage.getItem('reviews_' + postId)) {
        let cachedReviews = JSON.parse(localStorage.getItem('reviews_' + postId));
        renderReviews(cachedReviews);
      }

      // ✅ جلب التقييمات من Google Sheets فقط إذا كانت غير موجودة في الذاكرة المحلية
      let response = await fetch(`${scriptURL}?postId=${postId}`);
      if (!response.ok) throw new Error("فشل تحميل التقييمات.");
      
      let data = await response.json();
      localStorage.setItem('reviews_' + postId, JSON.stringify(data)); // تخزين التقييمات في الذاكرة المحلية
      renderReviews(data);

    } catch (error) {
      console.error("خطأ:", error);
      document.getElementById("reviews").innerHTML = "حدث خطأ أثناء تحميل التقييمات.";
    }
  }

  // ✅ عرض التقييمات
  function renderReviews(data) {
    let reviewsContainer = document.getElementById("reviews");
    reviewsContainer.innerHTML = "<h3>التقييمات</h3>";

    if (data.length === 0) {
      reviewsContainer.innerHTML += "<p>لا توجد تقييمات لهذه التدوينة بعد.</p>";
    } else {
      // حساب التقييم العام
      let totalStars = 0;
      data.forEach(review => {
        totalStars += parseInt(review.stars);
      });
      let averageStars = (totalStars / data.length).toFixed(2);

      // عرض التقييم العام على شكل نجوم
      let averageStarsHtml = generateStarsHtml(averageStars);

      // عرض التقييم العام
      reviewsContainer.innerHTML += `<p><strong>التقييم العام: ${averageStarsHtml}</strong></p>`;

      // عرض أول 3 تقييمات فقط
      const visibleReviews = data.slice(0, 3);
      visibleReviews.forEach(review => {
        let stars = "★".repeat(parseInt(review.stars)) + "☆".repeat(5 - parseInt(review.stars));
        reviewsContainer.innerHTML += `
          <div class="review">
            <strong>${review.username}</strong> - ${stars} (${review.stars}/5)
            <p>${review.comment}</p>
          </div>
        `;
      });

      // إضافة تقييمات مخفية مع تحميل المزيد عند التمرير
      const hiddenReviews = data.slice(3);
      hiddenReviews.forEach(review => {
        let stars = "★".repeat(parseInt(review.stars)) + "☆".repeat(5 - parseInt(review.stars));
        reviewsContainer.innerHTML += `
          <div class="review hidden">
            <strong>${review.username}</strong> - ${stars} (${review.stars}/5)
            <p>${review.comment}</p>
          </div>
        `;
      });

      // تفعيل التمرير لإظهار المزيد من التقييمات
      reviewsContainer.addEventListener("scroll", function () {
        if (reviewsContainer.scrollTop + reviewsContainer.clientHeight >= reviewsContainer.scrollHeight) {
          const hiddenReviews = document.querySelectorAll(".review.hidden");
          hiddenReviews.forEach((review) => {
            review.classList.remove("hidden");
          });
        }
      });
    }
  }

  // ✅ توليد النجوم بناءً على التقييم
  function generateStarsHtml(stars) {
    let fullStars = Math.floor(stars);
    let halfStar = (stars - fullStars) >= 0.5 ? '★' : '☆';
    let emptyStars = 5 - fullStars - (halfStar === '★' ? 1 : 0);

    let starsHtml = '★'.repeat(fullStars);
    if (halfStar === '★') starsHtml += '★';
    starsHtml += '☆'.repeat(emptyStars);
    
    return starsHtml;
  }
});
